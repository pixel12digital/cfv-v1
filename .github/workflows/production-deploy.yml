name: ðŸš€ Deploy to Production - CFC Bom Conselho

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

env:
  APP_NAME: "CFC Bom Conselho"
  DEPLOY_BRANCH: "master"

jobs:
  deploy:
    name: Deploy to Hostinger
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“‹ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        
    - name: ðŸ“¦ Cache dependencies
      id: cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.composer/cache
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-
          
    - name: ðŸ” Deploy to Hostinger
      id: deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOSTINGER_HOST }}
        username: ${{ secrets.HOSTINGER_USERNAME }}
        key: ${{ secrets.HOSTINGER_SSH_KEY }}
        port: ${{ secrets.HOSTINGER_PORT || '22' }}
        script: |
          set -e
          
          # Log do deploy
          echo "ðŸš€ [$(date)] Iniciando deploy do CFC Bom Conselho..." >> /tmp/deploy.log
          
          # Criar backup antes do deploy
          BACKUP_DIR="/backups/backup-$(date +%Y%m%d-%H%M%S)"
          echo "ðŸ’¾ Criando backup em: $BACKUP_DIR" >> /tmp/deploy.log
          mkdir -p "$BACKUP_DIR"
          cp -r /public_html/* "$BACKUP_DIR/" 2>/dev/null || true
          
          # Entrar no diretÃ³rio
          cd /public_html || { echo "âŒ Erro: NÃ£o consegui entrar em /public_html" >> /tmp/deploy.log; exit 1; }
          
          # Pull do cÃ³digo
          echo "ðŸ“¥ Fazendo pull do cÃ³digo..." >> /tmp/deploy.log
          git fetch origin
          git reset --hard origin/master
          git clean -fd
          
          # PermissÃµes corretas
          echo "ðŸ”§ Ajustando permissÃµes..." >> /tmp/deploy.log
          find . -type f -name "*.php" -exec chmod 644 {} \;
          find . -type d -exec chmod 755 {} \;
          chmod 666 logs/ 2>/dev/null || mkdir -p logs && chmod 666 logs/
          
          # Criar arquivo de versÃ£o
          echo "${{ github.sha }}" > .version
          echo "$(date)" >> .version
          
          echo "âœ… Deploy concluÃ­do com sucesso!" >> /tmp/deploy.log

    - name: ðŸ”” Notify Success
      if: success()
      run: |
        echo "âœ… Deploy concluÃ­do com sucesso!"
        echo "ðŸš€ CFC Bom Conselho atualizado em produÃ§Ã£o"
        echo "ðŸ“… Data/Hora: $(date)"

    - name: ðŸ“Š Deploy Summary
      if: always()
      run: |
        {
          echo "## Deploy Summary"
          echo "**App:** ${{ env.APP_NAME }}"
          echo "**Commit:** ${{ github.sha }}"
          echo "**Branch:** ${{ github.ref }}"
          echo "**Status:** ${{ job.status }}"
          _t="**Time:** $(date)"
          echo "$_t"
        } >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback if needed
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: ðŸ”„ Auto Rollback
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOSTINGER_HOST }}
        username: ${{ secrets.HOSTINGER_USERNAME }}
        key: ${{ secrets.HOSTINGER_SSH_KEY }}
        script: |
          echo "ðŸ”„ Iniciando rollback..." >> /tmp/deploy.log
          
          # Encontrar backup mais recente
          LATEST_BACKUP=$(ls -dt /backups/backup-* 2>/dev/null | head -1)
          
          if [ ! -z "$LATEST_BACKUP" ]; then
            echo "ðŸ“¦ Restaurando backup: $LATEST_BACKUP" >> /tmp/deploy.log
            rm -rf /public_html/* 2>/dev/null || true
            cp -r "$LATEST_BACKUP"/* /public_html/ 2>/dev/null || true
            echo "âœ… Rollback concluÃ­do" >> /tmp/deploy.log
          else
            echo "âŒ Nenhum backup encontrado para rollback" >> /tmp/deploy.log
          fi
